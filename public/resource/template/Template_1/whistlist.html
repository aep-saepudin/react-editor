<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Website Builder Template</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/modern-business.css" rel="stylesheet">

    <!-- Animate CSS -->
    <link rel="stylesheet" href="css/animate.css">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

<header>
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <img src="user-image/logo.png">
                <!--button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Logo</a-->
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right qw-list-item">
                    <li>
                        <a href="index.html">Home</a>
                    </li>
                    <li>
                        <a href="profile.html">Profile</a>
                    </li>
                    <li>
                        <a href="contact.html">Contact</a>
                    </li>
                    <li>
                        <a href="product.html">Product</a>
                    </li>
                    <li>
                        <a href="gallery.html">Gallery</a>
                    </li>
                    <li>
                        <a href="bonus.html">Bonus</a>
                    </li>
                    <li class="qw-list-default">
                        <a href="default.html">Default</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-account>Account <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="sign-up.html">Sign Up</a>
                            </li>
                            <li>
                                <a href="login.html">Login</a>
                            </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-login>My Account <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="account.html">My Account</a>
                            </li>
                            <li>
                                <a href="change-pass.html">Change Password</a>
                            </li>
                            <li>
                                <a href="address-book.html">Address Book</a>
                            </li>
                            <li>
                                <a href="view-cart.html">List Cart</a>
                            </li>
                            <li>
                                <a href="whistlist.html">Whist List</a>
                            </li>
                            <li>
                                <a href="order-history.html">Order History</a>
                            </li>
                            <li>
                                <a href="rewards-points.html">Rewards Points</a>
                            </li>
                            <li>
                                <a href="transactions.html">Transactions</a>
                            </li>
                            <li>
                                <a href="logout.php">Logout</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="view-cart.html">
                            <i class="fa fa-shopping-cart"></i> (<span count-cart>0</span>)
                        </a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>
</header>

    <section id="product">
    <!-- Page Content -->
    <div class="container">

        <!-- Page Heading/Breadcrumbs -->
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Whist List
                    <small>Whist List</small>
                </h1>
                <ol class="breadcrumb">
                    <li><a href="index.html">Home</a>
                    </li>
                    <li class="active">Whist List</li>
                </ol>
            </div>
        </div>
        <!-- /.row -->

        <!-- Product Row -->
        <div class="row" data-container>
                <style>
                    [data-default] {
                        display: none;
                    }
                </style>
    
        <!-- BEGIN PRODUCTS -->
        <div class="col-md-3 col-sm-6" data-item data-default>
            <span class="thumbnail">
                <div style="position: relative; width: 100%; height:200px; padding-right: 10px; margin-right: 10px;">
                    <center><img src="https://s12.postimg.org/41uq0fc4d/item_2_180x200.png" alt="..." data-image class="img-responsive" style="max-height: 200px"></center>
                </div>
                <h4 data-title style="height: 50px">Product Tittle</h4>
                <div class="ratings">
                    <span class="glyphicon glyphicon-star"></span>
                    <span class="glyphicon glyphicon-star"></span>
                    <span class="glyphicon glyphicon-star"></span>
                    <span class="glyphicon glyphicon-star"></span>
                    <span class="glyphicon glyphicon-star-empty"></span>
                </div>
                <p class="price" data-price></p>
                <hr class="line">
                <div class="row">
                    <!--div class="col-md-6 col-sm-6">
                        <p class="price" data-price></p>
                    </div-->
                    <template data-pid></template>
                    <center>
                        <button data-add="" class="btn btn-white btn-primary"><i class="fa fa-shopping-cart ui-droppable"></i> Add To Cart</button>
                        <button class="btn btn-danger" data-delete > DELETE</button>
                    </center>
                </div>
            </span>
        </div>
        <!-- END PRODUCTS -->
        </div>
        <br>
    </div>
    <!-- /.container -->
    </section>

    <!-- Footer -->
    <footer class="footer-bs">
        <div class="row">
            <div class="col-md-3 footer-brand animated fadeInLeft">
                <img src="user-image/logo.png">
                <p>Suspendisse hendrerit tellus laoreet luctus pharetra. Aliquam porttitor vitae orci nec ultricies. Curabitur vehicula, libero eget faucibus faucibus, purus erat eleifend enim, porta pellentesque ex mi ut sem.</p>
                <p>© 2017 World, All rights reserved</p>
            </div>
            <div class="col-md-3 footer-nav animated fadeInUp">
                <h4>Menu —</h4>
                <ul class="pages">
                    <li><a href="#">Home</a></li>
                    <li><a href="#">Profile</a></li>
                     <li><a href="#">Contact</a></li>
                    <li><a href="#">Product</a></li>
                    <li><a href="#">Gallery</a></li>
                </ul>
            </div>
            <div class="col-md-3 footer-social animated fadeInDown">
                <h4>Follow Us</h4>
                <ul>
                    <li><a href="#">Facebook</a></li>
                    <li><a href="#">Twitter</a></li>
                    <li><a href="#">Instagram</a></li>
                    <li><a href="#">RSS</a></li>
                </ul>
            </div>
            <div class="col-md-3 footer-ns animated fadeInRight">
                <h4>Contact</h4>
                <p>
                    3481 Melrose Place<br>Beverly Hills, CA 90210<br>
                </p>
                <p><i class="fa fa-phone"></i> 
                    <abbr title="Phone">P</abbr>: (123) 456-7890</p>
                <p><i class="fa fa-envelope-o"></i> 
                    <abbr title="Email">E</abbr>: <a href="mailto:name@example.com">name@example.com</a>
                </p>
                <p><i class="fa fa-clock-o"></i> 
                    <abbr title="Hours">H</abbr>: Monday - Friday: 9:00 AM to 5:00 PM
                </p>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Wow JS -->
    <script src="js/wow.min.js"></script>

    <!-- Custom JS -->
    <script src="js/costume.js"></script>

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        $(function () {
            loadWishList()
            getCustomerById()
        })

        function getClientServiceID() {
            return $.post('scid.txt')
            .then(res => {
                return JSON.parse(res)
            })
        }

        async function getCustomerById() {
            let scid = await getClientServiceID()
              customer_id = await getCostumerID()
            
            if(customer_id){
                $.post('https://build.web.id/api/customers/getCustomerdatabyId/', {
                  client_id: scid.cid,
                  service_id: scid.layanan_id,
                  customer_id: customer_id
                }).then(res => {
                    $('[data-login]').html(res.data.firstname+' '+res.data.lastname+' <b class="caret"></b>')
                    $('[data-account]').hide()
                })

                cid = window.atob(scid.cid),
                sid = window.atob(scid.layanan_id),
                $.post("https://build.web.id/api/cart/content/",{
                    "client_id": cid,
                    "service_id": sid,
                    "customer_id": customer_id
                },function(data){
                    $('[count-cart]').text(data.count)
                });
            }else{
                $('[data-login]').hide()
                $('[data-account]').show()

                swal("Anda belum login!", "Silahkan login terlebih dahulu!", "info")
                .then((value) => {
                    window.location.href = "login.html";
                });
            }
        }

        async function getWhistlist() {
            let
                scid = await getClientServiceID(),
                cid = window.atob(scid.cid),
                sid = window.atob(scid.layanan_id),
                co_id = await getCostumerID()

            return $.post('https://build.web.id/api/wishlist/data/', {
                    client_id: cid,
                    service_id: sid,
                    customer_id: co_id, // Todo Ganti nanti ya
                })

                .then(res => {
                    if(res.count==0){
                        $('[data-default]').show()
                        $('[data-default]').html('<div class="panel panel-default"><div class="panel-heading"><h3 class="panel-title">Whistlist</h3></div><div class="panel-body">Belum ada product dalam whistlist anda</div></div>')
                        $('[data-default]').removeClass()
                        $('[data-default]').addClass('col-md-12 col-sm-12')
                    }else{
                       return res.data 
                    }
                })

                .fail(res => {
                    console.log(res.responseText)
                })
        }

        async function saveCart(product_id) {
            let
                scid = await getClientServiceID(),
                cid = window.atob(scid.cid),
                sid = window.atob(scid.layanan_id),
                pid = parseInt(product_id),
                customer_id = await getCostumerID()

            if(customer_id){
                $.post('https://build.web.id/api/cart/add/', {
                    client_id: cid,
                    service_id: sid,
                    customer_id: customer_id,
                    product_id: pid,
                }, function (res, status) {
                    if(res.status==false){
                        swal("Product not found!", "Silahkan pilih product!", "info")
                        .then((value) => {
                          window.location.href = "product.html";
                        });
                    }else{
                       swal("Cart add!", "Successfully Add To Cart!", "success") 
                    }
                }).fail(res => {
                    console.log(res.responseText)
                })

                //remove product from whistlist
                removeProductCart(cid, sid, customer_id, product_id)
            }else{
                swal("Anda belum login!", "Silahkan login terlebih dahulu!", "info")
                .then((value) => {
                    window.location.href = "login.html";
                });
            }
        }

        async function loadWishList() {
            let
                wishLists = await getWhistlist(),
                scid = await getClientServiceID(),
                cid = window.atob(scid.cid),
                sid = window.atob(scid.layanan_id),
                co_id = await getCostumerID(),
                set_setting = await getConfigCurrency(scid.cid, scid.layanan_id)

            // load to html

            wishLists.forEach(wishlist => {
                let
                    clone = $('[data-default]').clone(),
                    modified_clone = clone.removeAttr("data-default")

                let
                    image = wishlist.product.image,
                    title = wishlist.product.name,
                    price = wishlist.product.price,
                    pid = wishlist.product_id

                    if(set_setting.code=='IDR'){
                        price = parseInt(price).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                    }else{
                        price = (price/set_setting.value).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                    }

                modified_clone.find('[data-image]').attr('src', image)
                modified_clone.find('[data-title]').html(title)
                //modified_clone.find('[data-price]').text(price)
                modified_clone.find('[data-price]').text(set_setting.symbol_left+' '+price)
                modified_clone.find('[data-pid]').text(pid)
                modified_clone.find('[data-add]').attr('onclick','saveCart('+wishlist.product_id+')');

                $('[data-container]').append(modified_clone)
            })

            $('[data-delete]').click(e => {
                let
                    container = $(e.target).closest('[data-item]'),
                    pid = container.find('[data-pid]').text()

                swal({
                    title: "Are you sure?",
                    text: "Once deleted, you will remove this product?",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                }).then((willDirect) => {
                    if (willDirect) {
                        if(co_id){
                            var req = $.post('https://build.web.id/api/wishlist/remove/', {
                                "client_id": cid,
                                "service_id": sid,
                                "customer_id": co_id, // Todo Ganti nanti ya
                                "product_id": pid,
                            }, function (res) {
                                swal("Poof! Your product has been deleted!", {
                                  icon: "success",
                                }).then((value) => {
                                    window.location.href = "whistlist.html";
                                });
                            })
                        }else{
                            swal("Anda belum login!", "Silahkan login terlebih dahulu!", "info")
                            .then((value) => {
                                window.location.href = "login.html";
                            });
                        }
                    } else {
                        swal("Your product is safe!");
                    }
                });
            })

            $('[data-update]').click(e => {

                let
                    container = $(e.target).closest('[data-item]'),
                    pid = container.find('[data-pid]').text(),
                    stock = container.find('[data-stock]').val(),
                    qty = stock



                var req = $.post('https://build.web.id/api/cart/update/', {

                    "client_id": cid,
                    "service_id": sid,
                    "customer_id": co_id, // Todo Ganti nanti ya
                    "product_id": pid,
                    "quantity": stock


                }, function (res) {
                    console.log(res)
                    alert(res.message)
                })

            })


            async function requestCart(e, action) {
                let
                    container = $(e.target).closest('[data-item]'),
                    pid = container.find('[data-pid]').text(),
                    scid = await getClientServiceID(),
                    cid = window.atob(scid.cid),
                    sid = window.atob(scid.layanan_id),
                    qty = 0,
                    co_id = await getCostumerID(),
                    msg = ""


                switch (action) {
                    case "delete":
                        qty = 0
                        msg = "Deleted"
                        break;

                    case "update":
                        let stock = container.find('[data-stock]').val()
                        qty = stock
                        msg = "Updated"
                        break;

                    default:
                        qty = 0
                        msg = "none"
                        break;
                }

                let data = {

                    "client_id": cid,
                    "service_id": sid,
                    "customer_id": co_id, // Todo Ganti nanti ya
                    "product_id": pid,
                    "quantity": qty,

                }


                // do request
                var req = $.post('https://build.web.id/api/cart/add/', data, function (res) {
                    alert("Product " + msg)
                    //location.reload()
                })
            }

        }

        function getCostumerID() {
            return $.post('getdata.php')
                .then(res => {
                    return res
                })
        }

        function getConfigCurrency(cid, sid){
            return $.post('https://build.web.id/api/setting/getLocalSetting/', {
                client_id: cid,
                service_id: sid
            }).then(res => {
                return res.data.config_currency
            })
        }

        function removeProductCart(cid, sid, customer_id, product_id){
            return $.post('https://build.web.id/api/wishlist/remove/', {
                client_id: cid,
                service_id: sid,
                customer_id: customer_id,
                product_id: product_id
            }).then(res => {
                window.location.href = "view-cart.html";
            })
        }
    </script>

</body>

</html>
