<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"    content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author"      content="Sergey Pozhilov (GetTemplate.com)">

	<title>Web Builder Template</title>

	<link rel="shortcut icon" href="assets/images/favicon.png">

	<!-- Bootstrap -->
	<link href="assets/css/bootstrap.no-icons.min.css" rel="stylesheet">
	<!-- Icons -->
	<link href="assets/css/font-awesome.css" rel="stylesheet">
	<!-- Fonts -->
	<link href="assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!-- Custom styles -->
	<link rel="stylesheet" href="assets/css/styles.css">

	<!--[if lt IE 9]> <script src="assets/js/html5shiv.js"></script> <![endif]-->
</head>
<body>

<header id="header">
	<div id="head" class="parallax qw-section" parallax-speed="2">
		<h1 id="logo" class="text-center" style="color: white;">
			<span class="title">Address Book</span>
			<span class="tagline">Example Tagline<br>
				<a href="#">example.blabla@example.com</a></span>
		</h1>
	</div>
	<nav class="navbar navbar-default navbar-sticky" style="margin-bottom: 0px">
		<div class="container-fluid">

			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
			</div>

			<div class="navbar-collapse collapse">

				<ul class="nav navbar-nav qw-list-item">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="profile.html">Profile</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="product.html">Product</a></li>
                    <li><a href="gallery.html">Gallery</a></li>
                    <li class="qw-list-default"><a href="default.html">Default</a></li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-account>Account<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="sign-up.html">Sign Up</a></li>
                            <li><a href="login.html">Login</a></li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" data-login>My Account<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="account.html">My Account</a></li>
                            <li><a href="change-pass.html">Change Password</a></li>
                            <li><a href="address-book.html">Address Book</a></li>
                            <li><a href="view-cart.html">List Cart</a></li>
                            <li><a href="whistlist.html">Whist List</a></li>
                            <li><a href="order-history.html">Order History</a></li>
                            <li><a href="rewards-points.html">Rewards Points</a></li>
                            <li><a href="transactions.html">Transactions</a></li>
                        </ul>
                    </li>
                </ul>

			</div><!--/.nav-collapse -->
		</div>
	</nav>
</header>


<main id="main">

	<section class="row topspace" id="contact-map">
		<div class="container" id="form-sign-up">
            <div class="row">
                <h1 style="color: black; text-align: center;"> List Cart </h1>
            </div>
            <div class="row">
                <div class="col-sm-8">

                        <style>
                            [data-default] {
                                display: none;
                            }

                            [data-item] [data-delete] {
                                float: right;
                                margin-right: 2em;
                            }

                            .qw-panel {
                                width: 25vw;
                                display: inline-block;
                                float: right;
                            }

                            .qw-panel .panel-title {
                                font-weight: bolder;
                            }

                            .qw-panel [data-checkout] {
                                float: right;
                                margin-bottom: 1em;
                                margin-right: 1em;
                            }

                            .qw-panel .panel-body {
                                font-size: 1.4em;
                            }

                            .qw-panel hr {
                                margin: 1em;
                                border-color: #4c4c4c;
                            }
                        </style>

                    <div class="row" data-container>
                        <div class="col-md-12 col-sm-12 panel panel-default" data-item data-default>
                            <span class="text-center">
                              <div class="row">
                                <div class="col-sm-4" style="position: relative; height: 200px; line-height: 200px; text-align: center;">
                                    <img src="http://placehold.it/350x280" alt="..." data-image="" class="col-sm-12" style="max-height: 200px; display: inline-block; vertical-align: middle; line-height: normal;">
                                </div>
                                <div class="col-sm-8" style="text-align: left;">
                                    <h4 class="text-danger" data-title="">Toyota Fortuner</h4>

                                    <p style="margin:0px">Qty :
                                        <input type="number" name="quantity" min="1" max="100" data-stock="">
                                        <!--button data-update="">Update</button-->
                                    </p>
                                    <p style="margin:0px">
                                        Price Per Unit :
                                        <span data-price-unit-curr="">10000</span>
                                    </p>
                                    <p style="margin:0px">
                                        Total Price :
                                        <span data-price="">10000</span>
                                        <span data-price-hitung="">10000</span>
                                    </p>
                                    <template data-pid></template>
                                    <template data-price-unit></template>
                                    <div class="row">
                                        <!-- <div class="col-md-6 col-sm-6">
                                            <button class="btn btn-primary right" data-checkout>Check Out</button>
                                        </div> -->
                                        <button class="btn btn-danger right" data-delete>Delete</button>
                                    </div>
                                </div>
                              </div>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Detail Cart</h3>
                        </div>
                        <div class="panel-body">Total Price:
                            <span data-total-price> </span>
                        </div>
                        <div class="panel-body right">
                            <a href="checkout.html"><button class="btn btn-danger right" data-checkout="">Checkout</button></a>
                        </div>
                    </div>
                </div>
            </div>
		</div>
	</section>

</main>

<footer id="footer">
	<div class="container">
		<div class="row">
			<div class="col-md-3 widget">
				<h3 class="widget-title">Contact</h3>
				<div class="widget-body">
					<p>+622152905148<br>
						<a href="mailto:#">example.blabla@example.com</a><br>
						<br>
						Jl. Coblong Selatan Bandung
					</p>
				</div>
			</div>

			<div class="col-md-3 widget">
				<h3 class="widget-title">Follow me</h3>
				<div class="widget-body">
					<p class="follow-me-icons">
						<a href="#"><i class="fa fa-twitter fa-2"></i></a>
						<a href="#"><i class="fa fa-dribbble fa-2"></i></a>
						<a href="#"><i class="fa fa-github fa-2"></i></a>
						<a href="#"><i class="fa fa-facebook fa-2"></i></a>
					</p>
				</div>
			</div>

			<div class="col-md-3 widget">
				<h3 class="widget-title">Text widget</h3>
				<div class="widget-body">
					<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Atque, nihil natus explicabo ipsum quia iste aliquid repellat eveniet velit ipsa sunt libero sed aperiam id soluta officia asperiores adipisci maxime!</p>
					<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Atque, nihil natus explicabo ipsum quia iste aliquid repellat eveniet velit ipsa sunt libero sed aperiam id soluta officia asperiores adipisci maxime!</p>
				</div>
			</div>

			<div class="col-md-3 widget">
				<h3 class="widget-title">Form widget</h3>
				<div class="widget-body">
					<p>+622152905148<br>
						<a href="mailto:#">example.blabla@example.com</a><br>
						<br>
						Jl. Coblong Selatan Bandung
					</p>
				</div>
			</div>

		</div> <!-- /row of widgets -->
	</div>
    <div class="container">
		<div class="row">

			<div class="col-md-6 widget">
				<div class="widget-body">
					<p>BDG JUARA </p>
				</div>
			</div>

			<div class="col-md-6 widget">
				<div class="widget-body">
					<p class="text-right">
						Copyright &copy; 2017, Web Builder Template<br>
						Design: <a href="#" rel="designer">Web Builder Template</a> </p>
				</div>
			</div>

		</div> <!-- /row of widgets -->
	</div>
</footer>
<a id="back-to-top" href="#" class="btn btn-primary back-to-top" role="button" title="Click to return on the top page" data-toggle="tooltip" data-placement="left"><span class="fa fa-arrow-up"></span></a>

<!-- JavaScript libs are placed at the end of the document so the pages load faster -->

	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/bootstrap.min.js"></script>
	<script src="assets/js/template.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        $(function () {
            loadCart()
            getCustomerById()
        })

        function getClientServiceID() {
            return $.post('scid.txt')
                .then(res => {
                    return JSON.parse(res)
                })
        }

        async function getCustomerById() {
          let scid = await getClientServiceID()
              customer_id = await getCostumerID()

          if(customer_id){
            return $.post('https://build.web.id/api/customers/getCustomerdatabyId/', {
              client_id: scid.cid,
              service_id: scid.layanan_id,
              customer_id: customer_id
            }).then(res => {
                $('[data-login]').html(res.data.firstname+' '+res.data.lastname+' <b class="caret"></b>')
                $('[data-account]').hide()
            })
          }else{
            $('[data-login]').hide()
            $('[data-account]').show()
          }
        }

        async function getCart() {
            let
                scid = await getClientServiceID(),
                cid = window.atob(scid.cid),
                sid = window.atob(scid.layanan_id),
                co_id = await getCostumerID()

            return $.post('https://build.web.id/api/cart/content/', {
                    client_id: cid,
                    service_id: sid,
                    customer_id: co_id, // Todo Ganti nanti ya
                })

                .then(res => {
                    //console.log(res)
                    return res
                })

                .fail(res => {
                    console.log(res.responseText)
                })
        }


        async function getProducts() {
            let cart = await getCart()
            return cart.data
        }

        async function getTotalPrice() {
            let cart = await getCart()
            return cart.total
        }

        async function changeFormat(number){
            let 
                scid = await getClientServiceID(),
                set_setting = await getConfigCurrency(scid.cid, scid.layanan_id)

            if(set_setting.code=='IDR'){
                number = parseInt(number).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
            }else{
                number = (number/set_setting.value).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
            }

            return set_setting.symbol_left+' '+number
        }

        async function updateCart(pid,stock){
            let scid = await getClientServiceID(),
                cid = window.atob(scid.cid),
                sid = window.atob(scid.layanan_id),
                customer_id = await getCostumerID()
            
            var req = $.post('https://build.web.id/api/cart/update/', {
                "client_id": cid,
                "service_id": sid,
                "customer_id": customer_id, 
                "product_id": pid,
                "quantity": stock
            }, function (res) { console.log(res.message)})
        }

        async function loadCart() {
            let
                products = await getProducts(),
                total_price = await getTotalPrice(),
                scid = await getClientServiceID(),
                cid = window.atob(scid.cid),
                sid = window.atob(scid.layanan_id),
                co_id = await getCostumerID(),
                set_setting = await getConfigCurrency(scid.cid, scid.layanan_id)

            if(!co_id){
                swal("Anda belum login!", "Silahkan login terlebih dahulu!", "info")
                .then((value) => {
                    window.location.href = "login.html";
                });
            }

            // load price to html
            $('[data-total-price]').text(await changeFormat(total_price))
            $('[data-price-hitung]').hide()
            
            if(products.length==0){
                $('[data-default]').show()
                $('[data-default]').html('<div class="panel panel-default"><div class="panel-heading"><h3 class="panel-title"><b>Product</b></h3></div><div class="panel-body">Belum ada product dalam list cart anda</div></div>')
                $('[data-checkout]').attr('disabled',true)
            }
            // load product to html
            products.forEach(async product => {
                let
                    clone = $('[data-default]').clone(),
                    modified_clone = clone.removeAttr("data-default")

                let
                    image = product.product_detail.image,
                    title = product.product_detail.name,
                    price = product.total_price,
                    stock = product.quantity,
                    pid = product.product_detail.product_id,
                    price_per_unit = product.product_detail.price
                    //price_per_unit_curr = await changeFormat(product.product_detail.price)

                    if(set_setting.code=='IDR'){
                        price_per_unit_curr = parseInt(price_per_unit).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                        set_price = parseInt(price).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                    }else{
                        price_per_unit_curr = parseInt(price_per_unit).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                        set_price = (price/set_setting.value).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                    }

                modified_clone.find('[data-image]').attr('src', image)
                modified_clone.find('[data-title]').html(title)
                modified_clone.find('[data-price-hitung]').text(price)
                modified_clone.find('[data-price]').text(set_setting.symbol_left+' '+set_price)
                modified_clone.find('[data-price-unit]').text(price_per_unit)
                modified_clone.find('[data-price-unit-curr]').text(set_setting.symbol_left+' '+price_per_unit_curr)
                modified_clone.find('[data-stock]').val(stock)
                modified_clone.find('[data-pid]').text(pid)


                $('[data-container]').append(modified_clone)
            })


            $('[data-delete]').click(e => {
                let
                    container = $(e.target).closest('[data-item]'),
                    pid = container.find('[data-pid]').text()

                swal({
                    title: "Are you sure?",
                    text: "Once deleted, you will remove this product?",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                }).then((willDirect) => {
                    if (willDirect) {
                        var req = $.post('https://build.web.id/api/cart/remove/', {
                            "client_id": cid,
                            "service_id": sid,
                            "customer_id": co_id, // Todo Ganti nanti ya
                            "product_id": pid,
                        }, function (res) {
                            swal("Poof! Your product has been deleted!", {
                              icon: "success",
                            }).then((value) => {
                                window.location.href = "view-cart.html";
                            });
                        })
                    } else {
                        swal("Your product is safe!");
                    }
                });
            })

            /*$('[data-update]').click(e => {

                let
                    container = $(e.target).closest('[data-item]'),
                    pid = container.find('[data-pid]').text(),
                    stock = container.find('[data-stock]').val(),
                    qty = stock

                var req = $.post('https://build.web.id/api/cart/update/', {

                    "client_id": cid,
                    "service_id": sid,
                    "customer_id": co_id, // Todo Ganti nanti ya
                    "product_id": pid,
                    "quantity": stock


                }, function (res) {
                    console.log(res)
                    alert(res.message)
                })

            })*/

            $('[data-stock]').unbind().change(async function (e) {
                    let
                        thisDataItem = $(this).closest('[data-item]'),
                        price_per_unit = parseInt(thisDataItem.find('[data-price-unit]').text()),
                        currentPrice = $(this).val() * price_per_unit,
                        total_price_new = 0,
                        siblings = thisDataItem.siblings().not('[data-default]'),
                        scid = await getClientServiceID(),
                        set_setting = await getConfigCurrency(scid.cid,scid.layanan_id),
                        pid = thisDataItem.find('[data-pid]').text(),
                        stock = thisDataItem.find('[data-stock]').val()
                    
                    let arrayofprice = $.map(siblings, function (sibling, index) {
                        return $(sibling).find('[data-price-hitung]').text()
                    })
                    const reducer = (accumulator, currentValue) => parseInt(accumulator) + parseInt(
                        currentValue);
                    
                    let sum = arrayofprice.reduce(reducer)
                    total_price_new = currentPrice + parseInt(sum);

                    updateCart(pid,stock)

                    thisDataItem.find('[data-price]').text(await changeFormat(currentPrice))
                    $('[data-total-price]').text(await changeFormat(total_price_new))
            })

            async function requestCart(e, action) {
                let
                    container = $(e.target).closest('[data-item]'),
                    pid = container.find('[data-pid]').text(),
                    scid = await getClientServiceID(),
                    cid = window.atob(scid.cid),
                    sid = window.atob(scid.layanan_id),
                    qty = 0,
                    co_id = await getCostumerID(),
                    msg = ""


                switch (action) {
                    case "delete":
                        qty = 0
                        msg = "Deleted"
                        break;

                    case "update":
                        let stock = container.find('[data-stock]').val()
                        qty = stock
                        msg = "Updated"
                        break;

                    default:
                        qty = 0
                        msg = "none"
                        break;
                }

                let data = {

                    "client_id": cid,
                    "service_id": sid,
                    "customer_id": co_id, // Todo Ganti nanti ya
                    "product_id": pid,
                    "quantity": qty,

                }

                // do request
                var req = $.post('https://build.web.id/api/cart/add/', data, function (res) {
                    alert("Product " + msg)
                    location.reload()
                })
            }

        }

        function getCostumerID() {
            return $.post('getdata.php')
                .then(res => {
                    return res
                })
        }

        function getConfigCurrency(cid, sid){
            return $.post('https://build.web.id/api/setting/getLocalSetting/', {
                client_id: cid,
                service_id: sid
            }).then(res => {
                return res.data.config_currency
            })
        }
    </script>
</body>
</html>
